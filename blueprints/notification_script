blueprint:
  name: Camera Notification Script
  description: Send notifications to multiple mobile devices with image
  domain: script
  source_url: https://github.com/home-assistant/blueprints
  author: Patrick
  input:
    notification_devices:
      name: Notification Devices
      description: Mobile devices to send notifications to (requires official Home
        Assistant app)
      selector:
        device:
          filter:
            integration: mobile_app
          multiple: true
    camera_entity:
      name: Camera Entity
      description: Camera to capture snapshots
      selector:
        entity:
          filter:
            domain: camera
    snapshot_directory:
      name: Snapshot Directory
      description: Directory to save snapshots (e.g., /config/www)
      selector:
        text: null
      default: /config/www
    snapshot_filename:
      name: Snapshot Filename (without extension)
      description: Filename prefix for snapshots
      selector:
        text: null
      default: snapshot
    image_base_url:
      name: Image Base URL
      description: Base URL for accessing snapshots (e.g., https://home.wachter.one/local/)
      selector:
        text: null
      default: https://home.wachter.one/local/
    notification_title:
      name: Notification Title
      description: Title for the notification
      selector:
        text: null
      default: Motion Detected ðŸ“¸
    notification_message:
      name: Notification Message
      description: Message for the notification
      selector:
        text: null
      default: Motion has been detected!
variables:
  camera_entity: camera_entity
  snapshot_directory: snapshot_directory
  snapshot_filename: snapshot_filename
  image_base_url: image_base_url
  notification_title: notification_title
  notification_message: notification_message
  raw_device: notification_devices
  timestamp: "{{ now().timestamp() | int }}"
  snapshot_file: "{{ snapshot_filename }}_{{ timestamp }}_{{ range(0, 100000) | random }}.png"
action:
  - parallel:
      - alias: Send motion detection notification without image to all devices
        repeat:
          for_each: "{{ raw_device }}"
          sequence:
            - variables:
                input_notify_device: "{{ 'notify.mobile_app_' ~ (device_attr(repeat.item,
                  'name') | slugify) }}"
            - service: "{{ input_notify_device }}"
              data:
                title: "{{ notification_title }}"
                message: "{{ notification_message }}"
                data:
                  clickAction: /lovelace-overview/uberwachung
                  tag: notification_alarm_yard
                  actions:
                    - action: URI
                      title: Home Assistant
                      uri: /dashboard-prototype/kameras
                    - action: URI
                      title: Open Instar
                      uri: app://de.instar.vision
                  group: Camera
                  channel: Camera
                  notification_icon: mdi:cctv
                  color: "#B73535"
                  alert_once: true
                  timeout: 300
                  ttl: 0
                  priority: high
      - sequence:
          - alias: Safety delay
            delay:
              milliseconds: "{{ range(0, 2) | random * 75 | float }}"
          - alias: Capture snapshot from camera
            action: camera.snapshot
            data:
              filename: "{{ snapshot_directory }}/{{ snapshot_file }}"
            target:
              entity_id: camera_entity
  - alias: Wait for snapshot to be written
    delay:
      milliseconds: 750
  - alias: Send motion detection notification with image to all devices
    repeat:
      for_each: "{{ raw_device }}"
      sequence:
        - variables:
            input_notify_device: "{{ 'notify.mobile_app_' ~ (device_attr(repeat.item,
              'name') | slugify) }}"
        - service: "{{ input_notify_device }}"
          data:
            title: "{{ notification_title }}"
            message: "{{ notification_message }}"
            data:
              image: "{{ image_base_url }}{{ snapshot_file }}"
              clickAction: /lovelace-overview/uberwachung
              tag: notification_alarm_yard
              actions:
                - action: URI
                  title: Home Assistant
                  uri: /dashboard-prototype/kameras
                - action: URI
                  title: Open Instar
                  uri: app://de.instar.vision
              group: Camera
              channel: Camera
              notification_icon: mdi:cctv
              color: "#B73535"
              alert_once: false
              timeout: 300
              ttl: 0
              priority: high
mode: single
